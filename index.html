<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Project Tracker - Miro App</title>
    <script src="https://miro.com/app/static/sdk/v2/miro.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            font-size: 13px;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .header { background: white; border-bottom: 1px solid #e0e0e0; padding: 16px 20px; display:flex; align-items:center; justify-content:space-between; flex-shrink:0; }
        .header-left { display:flex; align-items:center; gap:12px; }
        .app-icon { width:32px; height:32px; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:18px;}
        .header-title { font-size:16px; font-weight:600; color:#333; }
        .toolbar { background:#fafafa; border-bottom:1px solid #e0e0e0; padding:12px 20px; display:flex; gap:8px; flex-shrink:0; }
        .btn { padding:8px 16px; border:1px solid #ddd; background:white; border-radius:6px; cursor:pointer; font-size:12px; display:flex; align-items:center; gap:6px; transition:all .2s; }
        .btn:hover { background:#f0f0f0; border-color:#999; }
        .btn-primary { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border:none; }
        .btn-primary:hover { transform:translateY(-1px); box-shadow:0 4px 8px rgba(102,126,234,0.3); }
        .table-container { flex:1; overflow:auto; background:white; }
        table { width:100%; border-collapse:collapse; min-width:1200px; }
        thead { position:sticky; top:0; z-index:10; background:#fafafa; }
        th { padding:12px 16px; text-align:left; font-weight:600; color:#666; font-size:11px; text-transform:uppercase; border-bottom:2px solid #e0e0e0; white-space:nowrap; background:#fafafa; }
        td { padding:12px 16px; border-bottom:1px solid #f0f0f0; color:#333; }
        tbody tr { transition:background .2s; cursor:pointer; }
        tbody tr:hover { background:#f8f9fa; }
        .phase-group-header { background:#f5f5f5; font-weight:600; cursor:pointer; user-select:none; }
        .phase-badge { display:inline-block; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; }
        .phase-discover { background:#FFF9C4; color:#F57F17; }
        .phase-define { background:#C8E6C9; color:#2E7D32; }
        .phase-deliver { background:#BBDEFB; color:#1565C0; }
        .status-badge { display:inline-block; padding:4px 10px; border-radius:10px; font-size:11px; font-weight:600; }
        .health-indicator { width:28px; height:28px; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; font-weight:700; font-size:12px; }
        .health-g { background:#C8E6C9; color:#2E7D32; }
        .health-y { background:#FFF9C4; color:#F57F17; }
        .health-r { background:#FFCDD2; color:#C62828; }
        .editable { cursor:text; padding:8px; border-radius:4px; transition:background .2s; }
        .editable:hover { background:#f0f0f0; }
        input[type="date"], input[type="text"], select { border:none; background:transparent; font-family:inherit; font-size:inherit; color:inherit; width:100%; cursor:pointer; padding:4px; }
        input:focus, select:focus { outline:2px solid #667eea; border-radius:4px; background:white; }
        .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.5); z-index:1000; align-items:center; justify-content:center; }
        .modal.show { display:flex; }
        .modal-content { background:white; border-radius:12px; padding:24px; width:90%; max-width:500px; max-height:80vh; overflow-y:auto; }
        .modal-header { font-size:18px; font-weight:600; margin-bottom:20px; }
        .form-group { margin-bottom:16px; }
        .form-group label { display:block; font-weight:600; margin-bottom:6px; font-size:12px; color:#666; }
        .form-group input, .form-group select { width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:6px; font-size:13px; }
        .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:20px; }
        .progress-bar { height:8px; background:#e0e0e0; border-radius:4px; overflow:hidden; margin-top:4px; }
        .progress-fill { height:100%; background:linear-gradient(90deg,#667eea 0%,#764ba2 100%); transition:width .3s; }
        .delete-btn { color:#C62828; cursor:pointer; padding:4px 8px; border-radius:4px; transition:background .2s; }
        .delete-btn:hover { background:#FFCDD2; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="app-icon">📊</div>
            <div class="header-title">Project Tracker</div>
        </div>
        <div style="display:flex; gap:8px;">
            <button class="btn btn-primary" id="createOnMiroBtn">🚀 Create on Miro Board</button>
            <button class="btn" id="closeModalBtn" style="background:#f0f0f0;">✕ Close</button>
        </div>
    </div>

    <div class="toolbar">
        <button class="btn" id="addProjectBtn">➕ Add Project</button>
        <button class="btn" id="expandAllBtn">📂 Expand All</button>
        <button class="btn" id="collapseAllBtn">📁 Collapse All</button>
        <button class="btn" id="exportBtn">📤 Export</button>
    </div>

    <div class="table-container">
        <table id="projectTable">
            <thead>
                <tr>
                    <th style="width: 30px;"></th>
                    <th style="width: 40px;">⋮⋮</th>
                    <th style="width: 250px;">📋 Title</th>
                    <th style="width: 150px;">👥 Team</th>
                    <th style="width: 150px;">👤 Project Manager</th>
                    <th style="width: 120px;">📅 Start Date</th>
                    <th style="width: 120px;">📅 End Date</th>
                    <th style="width: 100px;">🔄 Phase</th>
                    <th style="width: 120px;">📊 Status</th>
                    <th style="width: 60px;">❤️ Health</th>
                    <th style="width: 100px;">📈 Progress</th>
                    <th style="width: 120px;">💰 Budget</th>
                    <th style="width: 150px;">📚 Resources</th>
                    <th style="width: 60px;">Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div id="projectModal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">Add New Project</div>
            <div class="form-group">
                <label>Project Title</label>
                <input type="text" id="modalTitle" placeholder="Enter project name">
            </div>
            <div class="form-group">
                <label>Phase</label>
                <select id="modalPhase">
                    <option value="Discover">Discover</option>
                    <option value="Define">Define</option>
                    <option value="Deliver">Deliver</option>
                </select>
            </div>
            <div class="form-group">
                <label>Team</label>
                <input type="text" id="modalTeam" placeholder="Team name">
            </div>
            <div class="form-group">
                <label>Project Manager</label>
                <input type="text" id="modalManager" placeholder="Manager name">
            </div>
            <div class="form-group">
                <label>Start Date</label>
                <input type="date" id="modalStartDate">
            </div>
            <div class="form-group">
                <label>End Date</label>
                <input type="date" id="modalEndDate">
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="modalStatus">
                    <option value="Not Started">Not Started</option>
                    <option value="Planning">Planning</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="On Hold">On Hold</option>
                </select>
            </div>
            <div class="form-group">
                <label>Health</label>
                <select id="modalHealth">
                    <option value="G">Green (Good)</option>
                    <option value="Y">Yellow (Warning)</option>
                    <option value="R">Red (Critical)</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn" id="cancelModalBtn">Cancel</button>
                <button class="btn btn-primary" id="saveProjectBtn">Save Project</button>
            </div>
        </div>
    </div>

    <script>
        let projects = [
            { id:1, title:'Product Brief', icon:'📄', team:'Design Team', manager:'John Doe', startDate:'2025-03-30', endDate:'2025-04-17', phase:'Discover', status:'In Progress', health:'R', progress:45, budget:'$10,000', resources:'Brief template, Research docs' },
            { id:2, title:'Research', icon:'🔍', team:'Research Team', manager:'Jane Smith', startDate:'2025-04-07', endDate:'2025-04-23', phase:'Discover', status:'Planning', health:'Y', progress:20, budget:'$5,000', resources:'Survey tools' },
            { id:3, title:'User Journey Diagrams', icon:'🗺️', team:'UX Team', manager:'Mike Johnson', startDate:'2025-04-11', endDate:'2025-04-29', phase:'Define', status:'In Progress', health:'G', progress:60, budget:'$8,000', resources:'Miro, Figma' },
            { id:4, title:'Prototypes', icon:'🎨', team:'Design Team', manager:'Sarah Lee', startDate:'2025-04-15', endDate:'2025-04-30', phase:'Define', status:'Not Started', health:'G', progress:0, budget:'$12,000', resources:'Figma, Sketch' },
            { id:5, title:'Build', icon:'🏗️', team:'Dev Team', manager:'Tom Brown', startDate:'2025-05-01', endDate:'2025-05-31', phase:'Deliver', status:'Not Started', health:'Y', progress:0, budget:'$50,000', resources:'GitHub, AWS' },
            { id:6, title:'Marketing Campaign', icon:'📢', team:'Marketing Team', manager:'Emma Wilson', startDate:'2025-05-13', endDate:'2025-05-31', phase:'Deliver', status:'Not Started', health:'G', progress:0, budget:'$15,000', resources:'Social media, Email' }
        ];
        let collapsedPhases = {};

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            const phases = ['Discover','Define','Deliver'];
            phases.forEach(phase => {
                const phaseProjects = projects.filter(p => p.phase === phase);
                if (phaseProjects.length === 0) return;
                const phaseRow = document.createElement('tr');
                phaseRow.className = 'phase-group-header';
                phaseRow.innerHTML = `<td colspan="14" onclick="togglePhase('${phase}')">
                    <span style="margin-right:10px;">${collapsedPhases[phase] ? '▶' : '▼'}</span>
                    <span class="phase-badge phase-${phase.toLowerCase()}">${phase}</span>
                    <span style="margin-left:10px; color:#666; font-size:12px;">${phaseProjects.length} project${phaseProjects.length>1?'s':''}</span>
                </td>`;
                tbody.appendChild(phaseRow);
                if (!collapsedPhases[phase]) {
                    phaseProjects.forEach(project => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><input type="checkbox" class="checkbox"></td>
                            <td style="color:#ccc; cursor:grab;">⋮⋮</td>
                            <td>
                                <span class="task-icon">${project.icon}</span>
                                <span class="editable" onclick="editCell(this, ${project.id}, 'title')">${escapeHtml(project.title)}</span>
                            </td>
                            <td class="editable" onclick="editCell(this, ${project.id}, 'team')">${escapeHtml(project.team)}</td>
                            <td class="editable" onclick="editCell(this, ${project.id}, 'manager')">${escapeHtml(project.manager)}</td>
                            <td><input type="date" value="${project.startDate}" onchange="updateProject(${project.id}, 'startDate', this.value)"></td>
                            <td><input type="date" value="${project.endDate}" onchange="updateProject(${project.id}, 'endDate', this.value)"></td>
                            <td>
                                <select onchange="updateProject(${project.id}, 'phase', this.value)">
                                    <option value="Discover" ${project.phase==='Discover'?'selected':''}>Discover</option>
                                    <option value="Define" ${project.phase==='Define'?'selected':''}>Define</option>
                                    <option value="Deliver" ${project.phase==='Deliver'?'selected':''}>Deliver</option>
                                </select>
                            </td>
                            <td><span class="status-badge status-${project.status.toLowerCase().replace(' ','-')}">${escapeHtml(project.status)}</span></td>
                            <td><span class="health-indicator health-${project.health.toLowerCase()}">${escapeHtml(project.health)}</span></td>
                            <td>
                                <div style="min-width:80px;">
                                    ${project.progress}%
                                    <div class="progress-bar"><div class="progress-fill" style="width:${project.progress}%"></div></div>
                                </div>
                            </td>
                            <td class="editable" onclick="editCell(this, ${project.id}, 'budget')">${escapeHtml(project.budget)}</td>
                            <td class="editable" onclick="editCell(this, ${project.id}, 'resources')">${escapeHtml(project.resources)}</td>
                            <td><span class="delete-btn" onclick="deleteProject(${project.id})">🗑️</span></td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            });
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
        }

        function togglePhase(phase) { collapsedPhases[phase] = !collapsedPhases[phase]; renderTable(); }
        function expandAll() { collapsedPhases = {}; renderTable(); }
        function collapseAll() { collapsedPhases = { Discover:true, Define:true, Deliver:true }; renderTable(); }
        function showAddModal() { document.getElementById('projectModal').classList.add('show'); document.getElementById('projectModal').setAttribute('aria-hidden','false'); }
        function closeModal() { document.getElementById('projectModal').classList.remove('show'); document.getElementById('projectModal').setAttribute('aria-hidden','true'); }

        function saveProject() {
            const newProject = {
                id: Date.now(),
                title: document.getElementById('modalTitle').value || 'Untitled',
                icon: '📌',
                team: document.getElementById('modalTeam').value || '',
                manager: document.getElementById('modalManager').value || '',
                startDate: document.getElementById('modalStartDate').value || '',
                endDate: document.getElementById('modalEndDate').value || '',
                phase: document.getElementById('modalPhase').value || 'Discover',
                status: document.getElementById('modalStatus').value || 'Not Started',
                health: document.getElementById('modalHealth').value || 'G',
                progress: 0,
                budget: '$0',
                resources: ''
            };
            projects.push(newProject);
            renderTable();
            closeModal();
            document.getElementById('modalTitle').value = '';
            document.getElementById('modalTeam').value = '';
            document.getElementById('modalManager').value = '';
        }

        function deleteProject(id) {
            if (confirm('Delete this project?')) {
                projects = projects.filter(p => p.id !== id);
                renderTable();
            }
        }

        function updateProject(id, field, value) {
            const project = projects.find(p => p.id === id);
            if (project) {
                project[field] = value;
                renderTable();
            }
        }

        function editCell(cell, id, field) {
            const currentValue = cell.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentValue;
            input.style.width = '100%';
            cell.textContent = '';
            cell.appendChild(input);
            input.focus();
            input.addEventListener('blur', function() { updateProject(id, field, this.value); });
            input.addEventListener('keypress', function(e) { if (e.key === 'Enter') this.blur(); });
        }

        // SDK V2 - Função corrigida para criar items no board
        async function createOnMiro() {
            try {
                const cardWidth = 300;
                const cardHeight = 200;
                const gap = 50;
                let xPos = 0;
                let yPos = 0;

                const phaseColors = { 
                    Discover: '#ffc700', 
                    Define: '#4caf50', 
                    Deliver: '#2196f3' 
                };

                for (const project of projects) {
                    // SDK v2 usa miro.board.createCard ou createStickyNote
                    await miro.board.createCard({
                        title: `${project.icon} ${project.title}`,
                        description: `Phase: ${project.phase}\nTeam: ${project.team}\nManager: ${project.manager}\nStatus: ${project.status}\nHealth: ${project.health}\nProgress: ${project.progress}%\nDates: ${project.startDate} → ${project.endDate}\nBudget: ${project.budget}`,
                        x: xPos,
                        y: yPos,
                        style: {
                            cardTheme: phaseColors[project.phase] || '#ffc700'
                        }
                    });

                    xPos += cardWidth + gap;
                    if (xPos > 2400) { xPos = 0; yPos += cardHeight + gap; }
                }

                await miro.board.notifications.showInfo('✅ Projects created on Miro Board!');
            } catch (err) {
                console.error('Error creating on Miro:', err);
                await miro.board.notifications.showError('Error creating projects. Check console for details.');
            }
        }

        async function closeModalWindow() {
            try {
                await miro.board.ui.closeModal();
            } catch (e) {
                closeModal();
            }
        }

        function exportData() {
            const csv = [
                ['Title','Team','Manager','Start Date','End Date','Phase','Status','Health','Progress','Budget','Resources'],
                ...projects.map(p => [p.title,p.team,p.manager,p.startDate,p.endDate,p.phase,p.status,p.health,p.progress,p.budget,p.resources])
            ].map(row => row.map(col => `"${String(col).replace(/"/g,'""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'project-tracker.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Event listeners
        document.getElementById('addProjectBtn').addEventListener('click', showAddModal);
        document.getElementById('cancelModalBtn').addEventListener('click', closeModal);
        document.getElementById('saveProjectBtn').addEventListener('click', saveProject);
        document.getElementById('createOnMiroBtn').addEventListener('click', createOnMiro);
        document.getElementById('closeModalBtn').addEventListener('click', closeModalWindow);
        document.getElementById('expandAllBtn').addEventListener('click', expandAll);
        document.getElementById('collapseAllBtn').addEventListener('click', collapseAll);
        document.getElementById('exportBtn').addEventListener('click', exportData);

        // Render inicial
        renderTable();

        // Inicialização do SDK v2
        miro.board.ui.on('icon:click', async () => {
            await miro.board.ui.openPanel({
                url: window.location.href,
                height: 700
            });
        });
    </script>
</body>
</html>
